{% extends "base.html" %}

{% block title %}Batches - Tutor Help{% endblock %}

{% block header_title %}Batches{% endblock %}

{% block content %}
<div style="margin-bottom: 1rem;">
    <a href="{{ url_for('batches.add_batch') }}" class="btn btn-primary btn-block">
        + Create New Batch
    </a>
</div>

{% if batches %}
    {% for batch in batches %}
    <div class="list-item" style="cursor: pointer;" onclick="window.location.href='{{ url_for('batches.batch_students', batch_id=batch.id) }}'">
        <div class="list-item-content" style="flex: 1;">
            <div class="list-item-title" style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                <span>{{ batch.name }}</span>
                {% if batch.start_time and batch.end_time %}
                <span style="color: #4F46E5; font-weight: 500; font-size: 0.85rem;">
                    üïê {{ batch.start_time }} - {{ batch.end_time }}
                </span>
                {% endif %}
            </div>
            <div class="list-item-subtitle" style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; font-size: 0.75rem;">
                <!-- Weekly Schedule -->
                {% if batch.days %}
                {% set day_codes = batch.days.split(',') if batch.days else [] %}
                <span style="display: flex; align-items: center; gap: 0.2rem; color: #666;">
                    {% if 'daily' in batch.days or batch.days == 'daily' %}
                    <span style="background: #D1FAE5; color: #065F46; padding: 0.1rem 0.35rem; border-radius: 4px; font-weight: 500; font-size: 0.65rem;">Daily</span>
                    {% else %}
                    {% for code in day_codes %}
                    {% if code and code.strip() %}
                    {% set day_name = {'mo': 'Mo', 'tu': 'Tu', 'we': 'We', 'th': 'Th', 'fr': 'Fr', 'sa': 'Sa', 'su': 'Su'}.get(code.strip().lower(), code.strip().upper()) %}
                    <span style="background: #F3F4F6; color: #374151; padding: 0.1rem 0.35rem; border-radius: 4px; font-weight: 500; font-size: 0.65rem;">{{ day_name }}</span>
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                </span>
                {% endif %}
                
                <!-- Description -->
                {% if batch.description %}
                <span style="color: #6B7280; font-size: 0.7rem; max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    {{ batch.description }}
                </span>
                {% endif %}
            </div>
        </div>
        <div class="list-item-actions" onclick="event.stopPropagation();">
            <a href="{{ url_for('batches.edit_batch', batch_id=batch.id) }}" class="btn btn-secondary btn-sm">
                Edit
            </a>
            <button onclick="deleteBatch({{ batch.id }})" class="btn btn-danger btn-sm">
                Delete
            </button>
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="empty-state">
        <div class="empty-state-icon">üìö</div>
        <h3>No batches yet</h3>
        <p>Create a batch to organize your students</p>
        <a href="{{ url_for('batches.add_batch') }}" class="btn btn-primary mt-2">
            Create Batch
        </a>
    </div>
{% endif %}

<script>
async function deleteBatch(batchId) {
    if (!confirm('Are you sure you want to delete this batch? Students in this batch will need to be reassigned.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/batches/${batchId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            location.reload();
        } else {
            alert(data.error || 'Failed to delete batch');
        }
    } catch (error) {
        alert('Error deleting batch');
    }
}
</script>
{% endblock %}
