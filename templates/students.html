{% extends "base.html" %}

{% block title %}Students - Tutor Help{% endblock %}

{% block header_title %}Students{% endblock %}

{% block content %}
<div style="margin-bottom: 1rem;">
    <a href="{{ url_for('add_student') }}" class="btn btn-primary btn-block">
        + Add New Student
    </a>
</div>

<div class="card" style="margin-bottom: 1rem;">
    <div class="form-group" style="margin-bottom: 0.75rem;">
        <input 
            type="text" 
            id="search-input" 
            class="form-input" 
            placeholder="ğŸ” Search by name or phone..."
            value="{{ search_query }}"
            onkeyup="handleSearch()"
        >
    </div>
    <div class="form-group" style="margin-bottom: 0;">
        <select id="batch-filter" class="form-select" onchange="handleFilter()">
            <option value="">All Batches</option>
            {% for batch in batches %}
            <option value="{{ batch.id }}" {% if batch_filter == batch.id %}selected{% endif %}>
                {{ batch.name }}
            </option>
            {% endfor %}
        </select>
    </div>
    {% if search_query or batch_filter %}
    <div style="margin-top: 0.75rem;">
        <a href="{{ url_for('students') }}" class="btn btn-secondary btn-sm">
            Clear Filters
        </a>
    </div>
    {% endif %}
</div>

{% if students %}
    {% for student in students %}
    <div class="list-item" style="cursor: pointer;" onclick="window.location.href='{{ url_for('view_student', student_id=student.id) }}'">
        <div class="list-item-content" style="flex: 1;">
            <div class="list-item-title">{{ student.name }}</div>
            <div class="list-item-subtitle">
                ğŸ“± {{ student.phone }} | ğŸ“š {{ student.batch_name or 'No Batch' }}
                {% if student.standard %}
                | ğŸ“ {{ student.standard }}
                {% endif %}
            </div>
            {% if student.school_name %}
            <div class="list-item-subtitle" style="margin-top: 0.25rem; font-size: 0.8rem;">
                ğŸ« {{ student.school_name }}
            </div>
            {% endif %}
        </div>
        <div class="list-item-actions" onclick="event.stopPropagation();">
            <a href="{{ url_for('edit_student', student_id=student.id) }}" class="btn btn-secondary btn-sm">
                Edit
            </a>
            <button onclick="deleteStudent({{ student.id }})" class="btn btn-danger btn-sm">
                Delete
            </button>
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="empty-state">
        <div class="empty-state-icon">ğŸ‘¥</div>
        <h3>No students yet</h3>
        <p>Add your first student to get started</p>
        <a href="{{ url_for('add_student') }}" class="btn btn-primary mt-2">
            Add Student
        </a>
    </div>
{% endif %}

<script>
let searchTimeout;
function handleSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        const search = document.getElementById('search-input').value;
        const batch = document.getElementById('batch-filter').value;
        updateFilters(search, batch);
    }, 300);
}

function handleFilter() {
    const search = document.getElementById('search-input').value;
    const batch = document.getElementById('batch-filter').value;
    updateFilters(search, batch);
}

function updateFilters(search, batch) {
    const params = new URLSearchParams();
    if (search) params.set('search', search);
    if (batch) params.set('batch', batch);
    window.location.href = `{{ url_for('students') }}?${params.toString()}`;
}

async function deleteStudent(studentId) {
    if (!confirm('Are you sure you want to delete this student?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/students/${studentId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to delete student');
        }
    } catch (error) {
        alert('Error deleting student');
    }
}
</script>
{% endblock %}

