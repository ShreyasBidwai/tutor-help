{% extends "base.html" %}

{% block title %}{{ batch.name }} - Students{% endblock %}

{% block header_title %}{{ batch.name }}{% endblock %}

{% block content %}
<div style="margin-bottom: 1rem;">
    <a href="{{ url_for('add_student') }}" class="btn btn-primary btn-block">
        + Add New Student
    </a>
</div>

<div class="card" style="margin-bottom: 1rem;">
    <div class="form-group" style="margin-bottom: 0;">
        <input 
            type="text" 
            id="search-input" 
            class="form-input" 
            placeholder="ğŸ” Search by name or phone..."
            value="{{ search_query }}"
            onkeyup="handleSearch()"
        >
    </div>
    {% if search_query %}
    <div style="margin-top: 0.75rem;">
        <a href="{{ url_for('batch_students', batch_id=batch.id) }}" class="btn btn-secondary btn-sm">
            Clear Search
        </a>
    </div>
    {% endif %}
</div>

{% if students %}
    {% for student in students %}
    <div class="list-item" style="cursor: pointer;" onclick="window.location.href='{{ url_for('view_student', student_id=student.id) }}'">
        <div class="list-item-content" style="flex: 1;">
            <div class="list-item-title">{{ student.name }}</div>
            <div class="list-item-subtitle">
                {% if student.standard %}
                ğŸ“ {{ student.standard }}
                {% endif %}
                {% if student.school_name %}
                {% if student.standard %} | {% endif %}ğŸ« {{ student.school_name }}
                {% endif %}
            </div>
            {% if student.phone %}
            <div class="list-item-subtitle" style="margin-top: 0.25rem; font-size: 0.8rem;">
                ğŸ“ {{ student.phone }}
            </div>
            {% endif %}
        </div>
        <div class="list-item-actions" onclick="event.stopPropagation();">
            <a href="{{ url_for('edit_student', student_id=student.id) }}" class="btn btn-secondary btn-sm">
                Edit
            </a>
            <button onclick="deleteStudent({{ student.id }})" class="btn btn-danger btn-sm">
                Delete
            </button>
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="empty-state">
        <div class="empty-state-icon">ğŸ‘¥</div>
        <h3>No students in this batch</h3>
        <p>{% if search_query %}No students found matching your search{% else %}Add students to this batch{% endif %}</p>
        <a href="{{ url_for('add_student') }}" class="btn btn-primary mt-2">
            Add Student
        </a>
    </div>
{% endif %}

<script>
let searchTimeout;
function handleSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        const search = document.getElementById('search-input').value;
        updateSearch(search);
    }, 300);
}

function updateSearch(search) {
    const params = new URLSearchParams();
    if (search) params.set('search', search);
    window.location.href = `{{ url_for('batch_students', batch_id=batch.id) }}?${params.toString()}`;
}

async function deleteStudent(studentId) {
    if (!confirm('Are you sure you want to delete this student?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/students/${studentId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to delete student');
        }
    } catch (error) {
        alert('Error deleting student');
    }
}
</script>
{% endblock %}

