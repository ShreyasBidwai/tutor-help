{% extends "base.html" %}

{% block title %}Attendance Reports - TuitionTrack{% endblock %}

{% block header_title %}Attendance Reports{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Last 7 Days Summary</h2>
    </div>
    <p style="color: #666; font-size: 0.875rem; margin-bottom: 1rem;">
        Attendance performance for the last 7 calendar days (including today)
    </p>
</div>

<!-- Search Bar -->
<div class="card" style="margin-bottom: 1rem;">
    <div style="position: relative;">
        <input 
            type="text" 
            id="searchInput" 
            placeholder="Search by name..." 
            class="form-input" 
            style="padding-left: 2.5rem;"
            onkeyup="filterResults()"
        >
        <span style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #999; font-size: 1.1rem;">ğŸ”</span>
    </div>
</div>

<!-- Tabs -->
<div class="card" style="padding: 0; background: white;">
    <div style="display: flex; border-bottom: 2px solid #E5E7EB; background: white;">
        <button 
            class="tab-button" 
            id="batchesTab"
            onclick="switchTab('batches')"
            style="flex: 1; padding: 1rem; background: {% if active_tab == 'batches' %}#4F46E5{% else %}white{% endif %}; color: {% if active_tab == 'batches' %}white{% else %}black{% endif %}; border: none; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: all 0.2s; border-bottom: 3px solid {% if active_tab == 'batches' %}#4F46E5{% else %}transparent{% endif %}; margin-bottom: -2px;"
        >
            Batches
        </button>
        <button 
            class="tab-button" 
            id="studentsTab"
            onclick="switchTab('students')"
            style="flex: 1; padding: 1rem; background: {% if active_tab == 'students' %}#4F46E5{% else %}white{% endif %}; color: {% if active_tab == 'students' %}white{% else %}black{% endif %}; border: none; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: all 0.2s; border-bottom: 3px solid {% if active_tab == 'students' %}#4F46E5{% else %}transparent{% endif %}; margin-bottom: -2px;"
        >
            Students
        </button>
    </div>
</div>

<!-- Batches Tab Content -->
<div id="batchesContent" style="display: {% if active_tab == 'batches' %}block{% else %}none{% endif %}; margin-top: 1rem;">
{% if batch_reports %}
    {% for report in batch_reports %}
        <a href="{{ url_for('reports.batch_report_detail', batch_id=report.batch_id) }}" class="report-item" data-name="{{ report.batch_name }}" style="text-decoration: none; color: inherit; display: block;">
            <div class="card" style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; margin-bottom: 0.75rem;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.12)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.08)'">
            <div class="card-header">
                <h3 class="card-title" style="font-size: 1rem;">ğŸ“š {{ report.batch_name }}</h3>
                <div style="text-align: right;">
                    <div style="font-size: 1.5rem; font-weight: 700; color: {% if report.attendance_percentage >= 80 %}#10B981{% elif report.attendance_percentage >= 60 %}#F59E0B{% else %}#EF4444{% endif %};">
                        {{ report.attendance_percentage }}%
                    </div>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 0.875rem; color: #666; margin-top: 0.5rem;">
                <span>{{ report.student_count }} students</span>
                <span>{{ report.attended_sessions }}/{{ report.total_expected }} sessions</span>
            </div>
        </div>
    </a>
    {% endfor %}
{% else %}
    <div class="empty-state">
        <div class="empty-state-icon">ğŸ“Š</div>
        <h3>No batches found</h3>
        <p>Create batches and add students to see attendance reports</p>
        <a href="{{ url_for('batches.add_batch') }}" class="btn btn-primary mt-2">
            Create Batch
        </a>
    </div>
{% endif %}
</div>

<!-- Students Tab Content -->
<div id="studentsContent" style="display: {% if active_tab == 'students' %}block{% else %}none{% endif %}; margin-top: 1rem;">
    {% if student_reports %}
        {% for report in student_reports %}
        <a href="{{ url_for('reports.student_report_detail', student_id=report.student_id) }}" class="report-item" data-name="{{ report.student_name }}" style="text-decoration: none; color: inherit; display: block; margin-bottom: 0.75rem;">
            <div class="card" style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.12)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.08)'">
                <div class="card-header">
                    <h3 class="card-title" style="font-size: 1rem;">ğŸ‘¤ {{ report.student_name }}</h3>
                    <div style="text-align: right;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: {% if report.attendance_percentage >= 80 %}#10B981{% elif report.attendance_percentage >= 60 %}#F59E0B{% else %}#EF4444{% endif %};">
                            {{ report.attendance_percentage }}%
                        </div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.875rem; color: #666; margin-top: 0.5rem;">
                    <span>ğŸ“š {{ report.batch_name }}</span>
                    <span>{{ report.attended_sessions }}/{{ report.total_expected }} days</span>
                </div>
            </div>
        </a>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">ğŸ“Š</div>
            <h3>No students found</h3>
            <p>Add students to see attendance reports</p>
            <a href="{{ url_for('students.add_student') }}" class="btn btn-primary mt-2">
                Add Student
            </a>
        </div>
    {% endif %}
</div>

<script>
function switchTab(tab) {
    // Update URL without reload
    const url = new URL(window.location);
    url.searchParams.set('tab', tab);
    window.history.pushState({}, '', url);
    
    // Get content divs
    const batchesContent = document.getElementById('batchesContent');
    const studentsContent = document.getElementById('studentsContent');
    
    // Get tab buttons
    const batchesTab = document.getElementById('batchesTab');
    const studentsTab = document.getElementById('studentsTab');
    
    if (!batchesContent || !studentsContent || !batchesTab || !studentsTab) {
        console.error('Tab elements not found');
        return;
    }
    
    // Show/hide content
    if (tab === 'batches') {
        batchesContent.style.display = 'block';
        studentsContent.style.display = 'none';
        
        batchesTab.style.background = '#4F46E5';
        batchesTab.style.color = 'white';
        batchesTab.style.borderBottom = '3px solid #4F46E5';
        studentsTab.style.background = 'white';
        studentsTab.style.color = 'black';
        studentsTab.style.borderBottom = '3px solid transparent';
    } else {
        studentsContent.style.display = 'block';
        batchesContent.style.display = 'none';
        
        studentsTab.style.background = '#4F46E5';
        studentsTab.style.color = 'white';
        studentsTab.style.borderBottom = '3px solid #4F46E5';
        batchesTab.style.background = 'white';
        batchesTab.style.color = 'black';
        batchesTab.style.borderBottom = '3px solid transparent';
    }
    
    // Clear search and reapply filter
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.value = '';
        filterResults();
    }
}

function filterResults() {
    const searchInput = document.getElementById('searchInput');
    if (!searchInput) return;
    
    const searchTerm = searchInput.value.toLowerCase();
    const batchesContent = document.getElementById('batchesContent');
    const studentsContent = document.getElementById('studentsContent');
    
    if (!batchesContent || !studentsContent) return;
    
    const activeTab = batchesContent.style.display !== 'none' ? 'batches' : 'students';
    const contentDiv = activeTab === 'batches' ? batchesContent : studentsContent;
    const items = contentDiv.querySelectorAll('.report-item');
    
    items.forEach(item => {
        const nameAttr = item.getAttribute('data-name');
        if (!nameAttr) return;
        
        const name = nameAttr.toLowerCase();
        if (name.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// Handle browser back/forward buttons
window.addEventListener('popstate', function(event) {
    const urlParams = new URLSearchParams(window.location.search);
    const tab = urlParams.get('tab') || 'batches';
    switchTab(tab);
});
</script>

<style>
.tab-button {
    outline: none;
}

/* Hover for unselected tabs (white background) */
.tab-button[style*="background: white"]:hover {
    background: #F3F4F6 !important;
}

/* Hover for selected tabs (purple background) */
.tab-button[style*="background: #4F46E5"]:hover {
    background: #4338CA !important;
}
</style>
{% endblock %}
