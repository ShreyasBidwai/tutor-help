{% extends "base.html" %}

{% block title %}Students - TuitionTrack{% endblock %}

{% block header_title %}Students{% endblock %}

{% block content %}
<!-- Action Buttons - Mobile Friendly -->
<div style="display: flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap;">
    <a href="{{ url_for('students.add_student') }}" class="btn btn-primary" style="flex: 1; min-width: 120px;">
        + Add Student
    </a>
    <a href="{{ url_for('export.export_students') }}" class="btn btn-secondary" style="flex: 1; min-width: 120px; display: flex; align-items: center; justify-content: center; gap: 0.5rem; {% if not students or students|length == 0 %}opacity: 0.6;{% endif %}">
        <span>üì•</span> <span>Export CSV</span>
    </a>
</div>

<div class="card" style="margin-bottom: 1rem;">
    <div class="form-group" style="margin-bottom: 0.75rem;">
        <input 
            type="text" 
            id="search-input" 
            class="form-input" 
            placeholder="üîç Search by name or phone..."
            value="{{ search_query }}"
            onkeyup="handleSearch()"
        >
    </div>
    <div class="form-group" style="margin-bottom: 0;">
        <select id="batch-filter" class="form-select" onchange="handleFilter()">
            <option value="">All Batches</option>
            {% for batch in batches %}
            <option value="{{ batch.id }}" {% if batch_filter == batch.id %}selected{% endif %}>
                {{ batch.name }}
            </option>
            {% endfor %}
        </select>
    </div>
    {% if search_query or batch_filter %}
    <div style="margin-top: 0.75rem;">
        <a href="{{ url_for('students.students') }}" class="btn btn-secondary btn-sm">
            Clear Filters
        </a>
    </div>
    {% endif %}
</div>

<!-- Skeleton for Students List -->
<div id="students-skeleton" class="skeleton-container active">
    {% for i in range(5) %}
    <div class="skeleton-list-item">
        <div class="skeleton skeleton-list-avatar"></div>
        <div class="skeleton-list-content">
            <div class="skeleton skeleton-line skeleton-title"></div>
            <div class="skeleton skeleton-line skeleton-text"></div>
            <div class="skeleton skeleton-line skeleton-text short"></div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Actual Students Content -->
<div id="students-content" class="content-loading">
{% if students %}
    {% for student in students %}
    <div class="list-item" style="cursor: pointer;" onclick="window.location.href='{{ url_for('students.view_student', student_id=student.id) }}'">
        <div class="list-item-content" style="flex: 1;">
            <div class="list-item-title">{{ student.name }}</div>
            <div class="list-item-subtitle">
                üìö {{ student.batch_name or 'No Batch' }}
                {% if student.standard %}
                | üéì {{ student.standard }}
                {% endif %}
            </div>
            {% if student.school_name %}
            <div class="list-item-subtitle" style="margin-top: 0.25rem; font-size: 0.8rem;">
                üè´ {{ student.school_name }}
            </div>
            {% endif %}
        </div>
        <div class="list-item-actions" onclick="event.stopPropagation();">
            <a href="{{ url_for('students.edit_student', student_id=student.id) }}" class="btn btn-secondary btn-sm">
                Edit
            </a>
            <button onclick="deleteStudent({{ student.id }})" class="btn btn-danger btn-sm">
                Delete
            </button>
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="empty-state">
        <div class="empty-state-icon">üë•</div>
        <h3>No students yet</h3>
        <p>Use the "Add Student" button above to get started</p>
    </div>
{% endif %}
</div>

{% if students and total_pages > 1 %}
<div style="display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: 1.5rem; padding: 1rem; flex-wrap: wrap;">
    <a href="{{ url_for('students.students', page=page-1, search=search_query, batch=batch_filter) if page > 1 else '#' }}" 
       class="btn btn-secondary btn-sm" 
       style="padding: 0.5rem 0.75rem; min-width: 80px; {% if page <= 1 %}opacity: 0.5; pointer-events: none;{% endif %}">
        ‚Üê Previous
    </a>
    
    <div style="display: flex; gap: 0.25rem; align-items: center; flex-wrap: wrap;">
        {% for p in range(1, total_pages + 1) %}
            {% if p == page %}
                <span style="padding: 0.5rem 0.75rem; background: #4F46E5; color: white; border-radius: 6px; font-weight: 600; min-width: 40px; text-align: center;">{{ p }}</span>
            {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
                <a href="{{ url_for('students.students', page=p, search=search_query, batch=batch_filter) }}" 
                   style="padding: 0.5rem 0.75rem; background: white; color: #4F46E5; border: 1px solid #E5E7EB; border-radius: 6px; text-decoration: none; min-width: 40px; text-align: center; font-weight: 500;">
                    {{ p }}
                </a>
            {% elif p == page - 3 or p == page + 3 %}
                <span style="padding: 0.5rem 0.25rem; color: #6B7280;">...</span>
            {% endif %}
        {% endfor %}
    </div>
    
    <a href="{{ url_for('students.students', page=page+1, search=search_query, batch=batch_filter) if page < total_pages else '#' }}" 
       class="btn btn-secondary btn-sm" 
       style="padding: 0.5rem 0.75rem; min-width: 80px; {% if page >= total_pages %}opacity: 0.5; pointer-events: none;{% endif %}">
        Next ‚Üí
    </a>
</div>
<div style="text-align: center; margin-top: 0.5rem; color: #6B7280; font-size: 0.875rem;">
    Showing {{ ((page - 1) * per_page) + 1 }} - {{ [page * per_page, total_count]|min }} of {{ total_count }} students
</div>
{% endif %}

<script>
let searchTimeout;
function handleSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        const search = document.getElementById('search-input').value;
        const batch = document.getElementById('batch-filter').value;
        updateFilters(search, batch);
    }, 300);
}

function handleFilter() {
    const search = document.getElementById('search-input').value;
    const batch = document.getElementById('batch-filter').value;
    updateFilters(search, batch);
}

function updateFilters(search, batch) {
    const params = new URLSearchParams();
    if (search) params.set('search', search);
    if (batch) params.set('batch', batch);
    params.set('page', '1'); // Reset to page 1 when filtering
    window.location.href = `{{ url_for('students.students') }}?${params.toString()}`;
}

async function deleteStudent(studentId) {
    const result = await Swal.fire({
        title: 'Delete Student?',
        text: 'Are you sure you want to delete this student? This action cannot be undone.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#EF4444',
        cancelButtonColor: '#6B7280',
        confirmButtonText: 'Yes, delete it',
        cancelButtonText: 'Cancel',
        reverseButtons: true
    });
    
    if (!result.isConfirmed) {
        return;
    }
    
    try {
        const response = await fetch(`/api/students/${studentId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            await Swal.fire({
                title: 'Deleted!',
                text: 'Student has been deleted successfully.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            location.reload();
        } else {
            await Swal.fire({
                title: 'Error!',
                text: 'Failed to delete student. Please try again.',
                icon: 'error',
                confirmButtonText: 'OK'
            });
        }
    } catch (error) {
        await Swal.fire({
            title: 'Error!',
            text: 'An error occurred while deleting the student.',
            icon: 'error',
            confirmButtonText: 'OK'
        });
    }
}
</script>
{% endblock %}

